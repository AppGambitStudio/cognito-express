## Synopsis

cognito-express is a npm-module authenticates API requests on a Node-Express application by verifying the signature of AccessToken or IDToken generated by Amazon Cognito.

## Installation 
```
npm install cognito-express --save
```

## Motivation

This is a simple module that authenticates web APIs by verifying the signature of AccessToken or IDToken - without needing to call Amazon Cognito for each API invocation. 

This module essentially bundles steps 1-7  listed on the official AWS documentation on  [Using ID Tokens and Access Tokens in your Web APIs](http://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-with-identity-providers.html#amazon-cognito-identity-user-pools-using-id-and-access-tokens-in-web-api)

1. Download and store the JSON Web Token (JWT) set for your user pool. 
2. Decode the token string into JWT format.
2. Check the iss claim. It should match your user pool. 
3. Check the token_use claim. It should match your set preference for 'access' or 'id' token types
4. Get the kid from the JWT token header and retrieve the corresponding JSON Web Key that was stored in step 1.
5. Verify the signature of the decoded JWT token.
6. Check the exp claim and make sure the token is not expired.

You can now trust the claims inside the token and use it as it fits your requirements.

## Prerequisites 

After successful authentication of a user, Amazon Cognito issues three tokens to the client:

- ID token
- Access token
- Refresh token

Save these tokens within the client app (preferably as cookies). 
When any API is invoked from client, pass in the AccessToken or IDToken to the server for verification.

It's completely upto you how you pass in the AccessToken or IDToken. 2 options:
1. By adding them explicitely in Request Headers
2. Just save the tokens as cookies. This way they get attached to request headers whenever APIs are invoked. (recommended)

## Configuration
```javascript
//Initializing CognitoExpress constructor
const cognitoExpress = new CognitoExpress({
	region: "us-east-1",
	cognitoUserPoolId: "us-east-1_dXlFef73t",
	tokenUse: "access", //Possible Values: access | id
	tokenExpiration: 3600000 //Up to default expiration of 1 hour (3600000 ms)
});
```
## Usage
```javascript
cognitoExpress.validate(accessTokenFromClient, function(err, success) {
	if (err) {
		/*
			//API is not authenticated, do something with the error.
		    //Perhaps redirect user back to the login page
			
			//ERROR TYPES:
			
			//If accessTokenFromClient is null or undefined
			err = {
			    "name": "TokenNotFound",
			    "message": "access token not found"
			}
			
			//If tokenuse doesn't match accessTokenFromClient
			{
			    "name": "WrongTokenUse",
			    "message": "Not an id token"
			}

			//If token expired
			err = {
			    "name": "TokenExpiredError",
			    "message": "jwt expired",
			    "expiredAt": "2017-07-05T16:41:59.000Z"
			}

			//If token's user pool doesn't match the one defined in constructor
			{
			    "name": "InvalidUserPool",
			    "message": "access token is not from the defined user pool"
			}

		*/
	} else {
		//Else API has been authenticated. Proceed.
		next();
	}
});


```
## Full Example 
```javascript
//app.js
"use strict";

const express = require("express"),
	CognitoExpress = require("cognito-express"),
	port = process.env.PORT || 8000;

const app = express(),
	authenticatedRoute = express.Router(); //I prefer creating a separate Router for authenticated requests

app.use("/api", authenticatedRoute);

//Initializing CognitoExpress constructor
const cognitoExpress = new CognitoExpress({
	region: "us-east-1",
	cognitoUserPoolId: "us-east-1_dXlFef73t",
	tokenUse: "access", //Possible Values: access | id
	tokenExpiration: 3600000 //Up to default expiration of 1 hour (3600000 ms)
});

//Our middleware that authenticates all APIs under our 'authenticatedRoute' Router
authenticatedRoute.use(function(req, res, next) {
	
	//I'm passing in the access token in header under key accessToken
	let accessTokenFromClient = req.headers.accesstoken;

	//Fail if tken not present in header. 
	if (!accessTokenFromClient) return res.status(401).send("Access Token missing from header");

	cognitoExpress.validate(accessTokenFromClient, function(err, response) {
		
		//If API is not authenticated, Return 401 with error message. 
		if (err) return res.status(401).send(err);
		
		//Else API has been authenticated. Proceed.
		next();
	});
});

authenticatedRoute.get("/myfirstapi", function(req, res, next) {
	res.send("If you're reading this, your API has been authenticated");
});

app.listen(port, function() {
	console.log(`Live on port: ${port}!`);
});
```

## Contributors

[Gary Arora](https://twitter.com/AroraGary)

## License

MIT